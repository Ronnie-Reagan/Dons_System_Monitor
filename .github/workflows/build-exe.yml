# .github/workflows/build-exe.yml
#
# Windows-only build workflow for Don's System Monitor
# Produces a PyInstaller single-file executable with a correctly named EXE:
#   "Don's System Monitor.exe"
#
# IMPORTANT:
# PyInstaller cannot safely generate a .spec file with apostrophes in --name.
# This workflow follows the required two-stage build flow:
#   1) Generate a safe .spec using a name WITHOUT apostrophes
#   2) Edit the .spec to replace the exe name using double-quoted Python strings
#   3) Build from the modified .spec file

name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-windows-exe:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psutil pyinstaller

      # Step 1: Generate a safe spec file (no apostrophe)
      - name: Generate PyInstaller spec file
        run: |
          pyinstaller --onefile --windowed --name "Dons System Monitor" --specpath . main.py

      # Step 2: Patch the spec file to use proper ownership naming
      # Replace:
      #   name='Dons System Monitor'
      # With:
      #   name="Don's System Monitor"
      - name: Patch spec file to include apostrophe
        run: |
          powershell -Command ^
            "(Get-Content 'Dons System Monitor.spec') ^
            -replace \"name='Dons System Monitor'\",\"name=\\\"Don's System Monitor\\\"\" ^
            | Set-Content 'Dons System Monitor.spec'"

      # Step 3: Build using the modified spec file
      - name: Build EXE from patched spec
        run: |
          pyinstaller "Dons System Monitor.spec"

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: Dons-System-Monitor-Windows
          path: dist/Don's System Monitor.exe
